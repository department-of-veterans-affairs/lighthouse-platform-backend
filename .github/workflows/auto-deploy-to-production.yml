name: Auto Deploy master to Production

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 13,14,15,16,17,18,19,20,21,22,23 * * 1,2,3,4,5'

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  run_checks_and_deploy:
    runs-on: ubuntu-latest
    outputs:
      mr_number: ${{ steps.get_mr_number.outputs.mr_number }}
      time_string: ${{ steps.get_time_string.outputs.time_string }}
    steps:
      - name: Set timezone to Eastern
        uses: szenius/set-timezone@v1.0
        with:
          timezoneLinux: 'America/New_York'
      - id: get_time_string
        name: Get time string for MR search
        run: |
          TIME_STRING=`date +"%Y/%m/%d %H:%M %Z" | sed -E 's/\:([03]{1}|[14]{1})[0-9]{1}/:\10/g' | sed 's/\:1/:0/' | sed 's/\:4/:3/'`
          echo $TIME_STRING
          echo "::set-output name=time_string::$TIME_STRING"
      - id: get_mr_number
        name: Grab matching deploy MR
        continue-on-error: true
        run: |
          TIME_STRING=`echo ${{steps.get_time_string.outputs.time_string}}`
          echo $TIME_STRING
          echo ${{ env.GITHUB_TOKEN }} | gh auth login --with-token
          gh issue list \
            -R 'department-of-veterans-affairs/lighthouse-platform-backend' \
            -l 'repo: lighthouse-platform-backend' \
            --limit 1 \
            --json id,number,state,labels,title,body \
            --jq "[.[]|select(.title==\"Deploy lighthouse-platform-backend to production ($TIME_STRING)\")][0]" \
            > issue.json
          cat issue.json
          MR_NUMBER=`jq -e ".number" issue.json`
          echo $MR_NUMBER
          if [ -z "$MR_NUMBER" ]; then
            # If there's no MR_NUMBER then exit because there's no open MR to deploy
            echo "No MR Found. Exiting..."
            exit 1;
          fi
          # If this errors, the MR isn't labeled "status: approved" at the time of it's scheduled deployment
          jq ".labels" issue.json | jq -e ".[] | select(.name==\"status: approved\")"
          echo "::set-output name=mr_number::$MR_NUMBER"
      - name: Disable Workflow till next MR is created
        # if: steps.deploy_to_production.outcome == 'success'
        run: |
          gh workflow disable 'Auto Deploy master to Production'
          exit 1;